# Recipe backend

This just a testing repository for me to familiarise myself more with backend concepts, after doing a lot of frontend work. This hopefully will include automatic deployments, separate languages, communication between service and security.

## Folder structure

* [.github/workflows](.github/workflows) Github actions defined here that test code in PRs and check that the proposed code can be deployed
* [./api](./api) Go API for recipes and ingredients, can be run with several instances as shards
* [./forager](./forager) A small Python service that fetches nutritional information from the [FoodData Central API](https://fdc.nal.usda.gov/)
* [./gateway](./gateway) A gateway that proxies requests to the right services to provide some obfuscation and a single point of contact for a frontend
* [./user](./user) Go user service, stores user information and provides authentication

## Deploying

The code is deployed with terraform to [Heroku](heroku.com), if code is merged to `main` it will check if changes were made to the relevant parts of the repository and then update the deployment automatically

* [main.tf](./main.tf) The terraform definition for what needs to be deployed to Heroku
* [.github/workflows/terraform-plan.yml](.github/workflows/terraform-plan.yml) The action runs on any PR to master and will determine the changes to the deployment that will be made and adds the information to the PR
* [.github/workflows/terraform-apply.yml](.github/workflows/terraform-apply.yml) This action runs when a push to `main` happens. It will apply all the necessary changes. This should generally be the same as what was created in the plan step, but they are not directly connected so they might differ.

## Configuration

The github actions are hard coded to create infrastructure with an `adtest` prefix, but this can be adjusted when running terraform by hand

### Repository settings

| Name | Description |
| --- | ---|
| `TF_BACKEND` | Connection string to a Postgre database that holds the current terraform state, used to init terraform in the github actions |
| `FOODDATA_TOKEN` | The [FoodData Central API](https://fdc.nal.usda.gov/) token, that is needed to retrieve the nutritional information, this is passed to the forager service through terraform |
| `HEROKU_EMAIL` | Account info to connect to [Heroku](heroku.com) |
| `HEROKU_API_KEY` | Account info to connect to [Heroku](heroku.com) |

### Recipe API

| Name | Description |
| --- | ---|
| `JWT_SECRET` | The secret that is used to sign the access tokens, generated by terraform in the setup |
| `CLOUDAMQP_URL` | Url for the rabbit mq service |
| `DATABASE_URL` | Url for the database |
| `SHARD` | The shard label, this is used for id generation and identification by other services |
| `APP_IN_QUEUE` | The name of the queue we retrieve ingredient results from, hard coded in terraform to `ingredients_results` the actual queue name will be this + shard to identify which shard requested the information |
| `APP_OUT_QUEUE` | The name of the queue we request ingredient information from, hard coded in terraform to `ingredients_lookup` |

### Forager

| Name | Description |
| --- | ---|
| `APP_TOKEN` | A token that safe-guards the lookup endpoint, shouldn't be needed since the service is run from the message queue |
| `APP_FOODDATA_TOKEN` | The [FoodData Central API](https://fdc.nal.usda.gov/) token, that is needed to retrieve the nutritional information |
| `APP_OUT_QUEUE` | The name of the queue we pass ingredient results to, hard coded in terraform to `ingredients_results` |
| `APP_IN_QUEUE` | The name of the queue we get ingredient information requests from, hard coded in terraform to `ingredients_lookup` |

### Gateway

| Name | Description |
| --- | --- |
| `JWT_SECRET` | The secret that is used to sign the access tokens, generated by terraform in the setup |
| `APP_USER_SERVICE` | Url for the user service |
| `APP_RECIPE_SHARDS` | Definition for the shards that are available for the recipe service, in the format `{"shards":[{"name":"shardName","url":"localhost:9902"}]}` |

### User Service

| Name | Description |
| --- | ---|
| `JWT_SECRET` | The secret that is used to sign the access tokens, generated by terraform in the setup |
| `DATABASE_URL` | Url for the database |
| `APP_RECIPE_SHARDS` | List of available shards `{"shards":[{"name":"shardName","url":"localhost:9902"}]}` |